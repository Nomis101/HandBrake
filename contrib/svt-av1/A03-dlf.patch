From b538cda62ca7f7dc1713e4a967f1b645518f46b1 Mon Sep 17 00:00:00 2001
From: Nomis101 <Nomis101@web.de>
Date: Tue, 15 Jul 2025 20:37:35 +0200
Subject: dlf

Signed-off-by: Nomis101 <Nomis101@web.de>
---
 Docs/Parameters.md                 |  2 +-
 Source/API/EbSvtAv1Enc.h           |  9 +++++++--
 Source/Lib/Codec/enc_mode_config.c | 10 +++++++++-
 Source/Lib/Globals/enc_settings.c  | 10 ++++++++--
 test/api_test/params.h             | 15 ++++++++-------
 5 files changed, 33 insertions(+), 13 deletions(-)

diff --git a/Docs/Parameters.md b/Docs/Parameters.md
index d8e1e1de..3b77e8c4 100644
--- a/Docs/Parameters.md
+++ b/Docs/Parameters.md
@@ -267,7 +267,7 @@ SvtAv1EncApp -i in.y4m -b out.ivf --roi-map-file roi_map.txt
 |----------------------------------|------------------------|----------------|-------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------|
 | **TileRow**                      | --tile-rows            | [0-6]          | 0           | Number of tile rows to use, `TileRow == log2(x)`, default changes per resolution                                                                                      |
 | **TileCol**                      | --tile-columns         | [0-4]          | 0           | Number of tile columns to use, `TileCol == log2(x)`, default changes per resolution                                                                                   |
-| **LoopFilterEnable**             | --enable-dlf           | [0-1]          | 1           | Deblocking loop filter control                                                                                                                                        |
+| **LoopFilterEnable**             | --enable-dlf           | [0-2]          | 1           | Deblocking loop filter control (1: enabled, 2: slower, more accurate filtering)                                                                                                                                       |
 | **CDEFLevel**                    | --enable-cdef          | [0-1]          | 1           | Enable Constrained Directional Enhancement Filter                                                                                                                     |
 | **EnableRestoration**            | --enable-restoration   | [0-1]          | 1           | Enable loop restoration filter                                                                                                                                        |
 | **EnableTPLModel**               | --enable-tpl-la        | [0-1]          | 1           | Temporal Dependency model control, currently forced on library side, only applicable for CRF/CQP                                                                      |
diff --git a/Source/API/EbSvtAv1Enc.h b/Source/API/EbSvtAv1Enc.h
index 1efc8604..e98429b1 100644
--- a/Source/API/EbSvtAv1Enc.h
+++ b/Source/API/EbSvtAv1Enc.h
@@ -45,6 +45,8 @@ extern "C" {
 #endif
 #endif /* ATTRIBUTE_PACKED */
 typedef enum ATTRIBUTE_PACKED {
+    ENC_MRS        = -3, // Highest quality research mode (slowest)
+    ENC_MRP        = -2, // Previous research mode with quality/speed tradeoffs found in v1.8.0
     ENC_MR         = -1, //Research mode with higher quality than M0
     ENC_M0         = 0,
     ENC_M1         = 1,
@@ -620,9 +622,12 @@ typedef struct EbSvtAv1EncConfiguration {
     /**
      * @brief Deblocking loop filter control
      *
-     * Default is true.
+     * 0: disabled
+     * 1: enabled
+     * 2: more accurate (slower)
      */
-    bool enable_dlf_flag;
+    uint8_t enable_dlf_flag;
+
     /* Film grain denoising the input picture
     * Flag to enable the denoising
     *
diff --git a/Source/Lib/Codec/enc_mode_config.c b/Source/Lib/Codec/enc_mode_config.c
index f5b1c30f..e6bbcf89 100644
--- a/Source/Lib/Codec/enc_mode_config.c
+++ b/Source/Lib/Codec/enc_mode_config.c
@@ -13232,8 +13232,16 @@ set lpd0_level
     }
     uint8_t dlf_level = 0;
     if (pcs->scs->static_config.enable_dlf_flag && frm_hdr->allow_intrabc == 0) {
+        EncMode dlf_enc_mode = enc_mode;
+
+        if (pcs->scs->static_config.enable_dlf_flag == 2) {
+            // trade off more accurate deblocking for longer encode time
+            // use dlf_mode as if were being set for 3 presets lower
+            dlf_enc_mode = AOMMAX(ENC_MRS, enc_mode - 3);
+        }
+
         dlf_level = get_dlf_level(pcs,
-                                  enc_mode,
+                                  dlf_enc_mode,
                                   is_not_last_layer,
                                   fast_decode,
                                   input_resolution,
diff --git a/Source/Lib/Globals/enc_settings.c b/Source/Lib/Globals/enc_settings.c
index 7b40b0d7..26f23578 100644
--- a/Source/Lib/Globals/enc_settings.c
+++ b/Source/Lib/Globals/enc_settings.c
@@ -286,6 +286,12 @@ EbErrorType svt_av1_verify_settings(SequenceControlSet *scs) {
         SVT_ERROR("Instance %u: Invalid intra Refresh Type [1-2]\n", channel_number + 1);
         return_error = EB_ErrorBadParameter;
     }
+
+    if (config->enable_dlf_flag > 2) {
+        SVT_ERROR("Instance %u: Invalid LoopFilterEnable. LoopFilterEnable must be [0 - 2]\n", channel_number + 1);
+        return_error = EB_ErrorBadParameter;
+    }
+
     if (config->rate_control_mode > SVT_AV1_RC_MODE_CBR &&
         (config->pass == ENC_FIRST_PASS || config->rc_stats_buffer.buf)) {
         SVT_ERROR("Instance %u: Only rate control mode 0~2 are supported for 2-pass \n", channel_number + 1);
@@ -996,7 +1002,7 @@ EbErrorType svt_av1_set_default_params(EbSvtAv1EncConfiguration *config_ptr) {
 #else
     config_ptr->pred_structure = SVT_AV1_PRED_RANDOM_ACCESS;
 #endif
-    config_ptr->enable_dlf_flag              = true;
+    config_ptr->enable_dlf_flag              = 1;
     config_ptr->cdef_level                   = DEFAULT;
     config_ptr->enable_restoration_filtering = DEFAULT;
     config_ptr->enable_mfmv                  = DEFAULT;
@@ -2111,6 +2117,7 @@ EB_API EbErrorType svt_av1_enc_parse_parameter(EbSvtAv1EncConfiguration *config_
         {"superres-kf-denom", &config_struct->superres_kf_denom},
         {"tune", &config_struct->tune},
         {"film-grain-denoise", &config_struct->film_grain_denoise_apply},
+        {"enable-dlf", &config_struct->enable_dlf_flag},
         {"resize-mode", &config_struct->resize_mode},
         {"resize-denom", &config_struct->resize_denom},
         {"resize-kf-denom", &config_struct->resize_kf_denom},
@@ -2222,7 +2229,6 @@ EB_API EbErrorType svt_av1_enc_parse_parameter(EbSvtAv1EncConfiguration *config_
         bool       *out;
     } bool_opts[] = {
         {"use-q-file", &config_struct->use_qp_file},
-        {"enable-dlf", &config_struct->enable_dlf_flag},
         {"enable-overlays", &config_struct->enable_overlays},
         {"enable-force-key-frames", &config_struct->force_key_frames},
 #if CONFIG_ENABLE_QUANT_MATRIX
diff --git a/test/api_test/params.h b/test/api_test/params.h
index 0ac41119..0cb91282 100644
--- a/test/api_test/params.h
+++ b/test/api_test/params.h
@@ -408,15 +408,16 @@ static const vector<bool> invalid_use_qp_file = {
 /* Flag to enable the Deblocking Loop Filtering.
  *
  * Default is true. */
-static const vector<bool> default_enable_dlf_flag = {
-    true,
+static const vector<uint8_t> default_enable_dlf_flag = {
+    1,
 };
-static const vector<bool> valid_enable_dlf_flag = {
-    false,
-    true,
+static const vector<uint8_t> valid_enable_dlf_flag = {
+    0,
+    1,
+    2,
 };
-static const vector<bool> invalid_enable_dlf_flag = {
-    // none
+static const vector<uint8_t> invalid_enable_dlf_flag = {
+    3
 };
 
 /* Film grain denoising the input picture
-- 
2.50.1

